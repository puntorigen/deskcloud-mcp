# ==============================================================================
# DeskCloud MCP - Docker Compose
# ==============================================================================
#
# Development and production deployment configuration.
#
# Usage:
#   # Development
#   docker-compose up --build
#
#   # Production
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# ==============================================================================

version: "3.9"

services:
  # ============================================================================
  # Main Application
  # ============================================================================
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: deskcloud-mcp
    
    # Port mappings
    ports:
      - "8000:8000"   # FastAPI backend
      - "8080:8080"   # Frontend static server
      - "6080:6080"   # noVNC web interface (base/unused)
      - "5900:5900"   # Direct VNC (base/unused)
      # Session VNC ports (each session gets its own display)
      # noVNC web interface for sessions (browser-accessible)
      - "6081:6081"   # Session 1 noVNC
      - "6082:6082"   # Session 2 noVNC
      - "6083:6083"   # Session 3 noVNC
      - "6084:6084"   # Session 4 noVNC
      - "6085:6085"   # Session 5 noVNC
      # Direct VNC ports for sessions (VNC client access)
      - "5901:5901"   # Session 1 VNC
      - "5902:5902"   # Session 2 VNC
      - "5903:5903"   # Session 3 VNC
      - "5904:5904"   # Session 4 VNC
      - "5905:5905"   # Session 5 VNC
    
    # Capabilities for OverlayFS (filesystem isolation)
    # CAP_SYS_ADMIN is required for mount operations
    cap_add:
      - SYS_ADMIN
    
    # Security options for OverlayFS
    security_opt:
      - apparmor:unconfined
    
    # Environment variables
    environment:
      # Required: Claude API key
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
      # API provider (anthropic, bedrock, vertex)
      - API_PROVIDER=${API_PROVIDER:-anthropic}
      
      # Database URL (SQLite default, can use PostgreSQL)
      - DATABASE_URL=${DATABASE_URL:-sqlite+aiosqlite:///./data/sessions.db}
      
      # Display settings
      - DISPLAY_NUM=1
      - WIDTH=${WIDTH:-1024}
      - HEIGHT=${HEIGHT:-768}
      
      # Debug mode (set to 'true' for development)
      - DEBUG=${DEBUG:-false}
      
      # CORS origins (comma-separated)
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:8080,http://localhost:3000}
      
      # Filesystem isolation settings
      - SESSIONS_DIR=${SESSIONS_DIR:-/sessions}
      - FILESYSTEM_BASE_DIR=${FILESYSTEM_BASE_DIR:-/sessions/base}
      - FILESYSTEM_ISOLATION_ENABLED=${FILESYSTEM_ISOLATION_ENABLED:-true}
    
    # Volume mounts
    volumes:
      # Persist session database
      - ./data:/home/computeruse/data
      
      # Persist Anthropic settings (API key, etc.)
      - ~/.anthropic:/home/computeruse/.anthropic
      
      # Persist session filesystems (for OverlayFS isolation)
      - sessions-data:/sessions
      
      # Development: mount source for hot reload (optional)
      # - ./app:/home/computeruse/app
      # - ./frontend:/home/computeruse/frontend
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    
    # Restart policy
    restart: unless-stopped

# ==============================================================================
# Optional: PostgreSQL for Production
# ==============================================================================
# Uncomment the following for production deployment with PostgreSQL
#
#   db:
#     image: postgres:15-alpine
#     container_name: deskcloud-mcp-db
#     environment:
#       POSTGRES_DB: computeruse
#       POSTGRES_USER: app
#       POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U app -d computeruse"]
#       interval: 10s
#       timeout: 5s
#       retries: 5
#     restart: unless-stopped
#
# volumes:
#   postgres_data:

# ==============================================================================
# Volumes
# ==============================================================================

volumes:
  sessions-data:
    name: deskcloud-mcp-sessions
    driver: local

# ==============================================================================
# Networks
# ==============================================================================

networks:
  default:
    name: deskcloud-mcp-network

